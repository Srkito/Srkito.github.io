<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title> | 百年大佬</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="百年大佬" type="application/atom+xml">
</head><body><header><nav><a href="/">主页</a><a href="/archives/">归档</a><a href="/about/">关于</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2021-04-16T13:05:51.489Z" id="date"> 2021-04-16</time></span><br><span>updated:<time datetime="2021-04-16T13:06:06.473Z" id="updated"> 2021-04-16</time></span></div><h1></h1><hr></div><div id="post-content"><h1 id="面试问题"><a href="#面试问题" class="headerlink" title="面试问题"></a>面试问题</h1><h3 id="抓包抓不到-怎么办"><a href="#抓包抓不到-怎么办" class="headerlink" title="抓包抓不到 怎么办"></a>抓包抓不到 怎么办</h3><blockquote>
<p>SSL Pinning（一种用来防止中间人攻击的技术，广泛应用于阻止app的抓包和嗅探。）</p>
</blockquote>
<ol>
<li>降低版本——降低App和Android系统的版本<br>很多SSL验证和其他防护都是在新版app中才有的，而且一些方案都是Android 7.0以后才开始生效，所以为了抓到包，我建议的配置环境是Andorid 5的模拟器 + 较低版本的APP。如何获得较低版本的APP，百度豌豆荚应用商城，可以下载APP的历史版本，有的app太旧的版本是无法正常使用的，所以需要多尝试几个旧版，一般来说，只距离现在半年的app版本是可以用的。</li>
<li>禁止校验——禁止app内部的ssl 证书校验<br>如何禁止app内部的ssl 证书校验？我们可以直接Hook掉app验证SSL Pinning的方法Android平台上我们可以使用Xposed+Justtrustme</li>
<li>Drony(VPN)+CharlesVPN导流抓包 手机请求先到VPN再对VPN的网络进行Charles代理</li>
</ol>
<h3 id="防抓包"><a href="#防抓包" class="headerlink" title="防抓包"></a>防抓包</h3><ol>
<li>判断系统当前是否设置代理<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isProxy</span><span class="hljs-params">()</span> </span>&#123;<br>    String proxyAddress = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">int</span> proxyPort = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;            proxyAddress = System.getProperty(<span class="hljs-string">&quot;http.proxyHost&quot;</span>);<br>        String proxyPortString = System.getProperty(<span class="hljs-string">&quot;http.proxyPort&quot;</span>);<br>        proxyPort = Integer.parseInt((proxyPortString != <span class="hljs-keyword">null</span> ? proxyPortString : <span class="hljs-string">&quot;-1&quot;</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        proxyAddress = android.net.Proxy.getHost(<span class="hljs-keyword">this</span>);<br>        proxyPort = android.net.Proxy.getPort(<span class="hljs-keyword">this</span>);<br>    &#125;        <br>    <span class="hljs-keyword">if</span> (!TextUtils.isEmpty(proxyAddress) &amp;&amp; proxyPort != -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;        <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>使用OkHttp设置简单的不允许抓包-&gt;Proxy.NO_PROXY（无法防止导流）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient.Builder()<br>            .proxy(Proxy.NO_PROXY)<br>            .build();<br>Request request = <span class="hljs-keyword">new</span> Request.Builder()<br>        .url(<span class="hljs-string">&quot;https://wanandroid.com/wxarticle/chapters/json &quot;</span>)                <br>        .build();<br>Call call = okHttpClient.newCall(request);<br>call.enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> </span>&#123;<br>        Log.e(<span class="hljs-string">&quot;===MockingJay===&quot;</span>, <span class="hljs-string">&quot;getNoHttpData    onFailure...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Log.e(<span class="hljs-string">&quot;===MockingJay===&quot;</span>, <span class="hljs-string">&quot;getNoHttpData    onResponse...&quot;</span>);<br>        String str = response.body().string();<br>        Log.e(<span class="hljs-string">&quot;===MockingJay===&quot;</span>, <span class="hljs-string">&quot;getNoHttpData    str:&quot;</span> + str);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure></li>
<li>强制使用证书校验（阻止导流抓包）<br>这种方式要在app嵌入证书，以okhttp为例：</li>
</ol>
<p>当okhttp使用X509TrustManager对服务器证书进行校验时，如果服务器证书的 subjectDN 和嵌入证书的 subjectDN 一致，我们再进行签名内容 signature 的比对，如果不一致，抛出异常。示例代码如下：</p>
<ol>
<li>从本地读取证书：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">val myCrt: X509Certificate by lazy &#123;<br>    getCrt(R.raw.my_ca)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> fun <span class="hljs-title">getCrt</span><span class="hljs-params">(<span class="hljs-meta">@RawRes</span> raw: Int)</span>: X509Certificate </span>&#123;<br>    val certificateFactory = CertificateFactory.getInstance(<span class="hljs-string">&quot;X.509&quot;</span>)<br>    val input = ApplicationContext.resources.openRawResource(raw)<br>    input.use &#123;<br>        <span class="hljs-keyword">return</span> certificateFactory.generateCertificate(input) as X509Certificate<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>检查服务器证书时对比嵌入的证书<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> fun <span class="hljs-title">getTrustManagerInRelease</span><span class="hljs-params">()</span>: X509TrustManager </span>&#123;<br>    <span class="hljs-keyword">return</span> object : X509TrustManager &#123;<br><br>        <span class="hljs-function">override fun <span class="hljs-title">checkClientTrusted</span><span class="hljs-params">(chain: Array&lt;X509Certificate&gt;, authType: String?)</span> </span>&#123;&#125;<br><br>        <span class="hljs-function">override fun <span class="hljs-title">getAcceptedIssuers</span><span class="hljs-params">()</span>: Array&lt;X509Certificate&gt; </span>= arrayOf()<br><br>        <span class="hljs-function">override fun <span class="hljs-title">checkServerTrusted</span><span class="hljs-params">(chain: Array&lt;X509Certificate&gt;, authType: String?)</span> </span>&#123;<br>            val myCrt: X509Certificate = myCrt<br>            <span class="hljs-keyword">if</span> (chain[<span class="hljs-number">0</span>].subjectDN.name == myCrt.subjectDN.name) &#123;<br>                <span class="hljs-keyword">if</span> (!myCrt.signature!!.contentEquals(chain[<span class="hljs-number">0</span>].signature)) &#123;<br>                    <span class="hljs-keyword">throw</span> SSLHandshakeException(<span class="hljs-string">&quot;签名不符！&quot;</span>)<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>将自定义的 SSLSocketFactory 和 X509TrustManager 将入到 okhttp 客户端:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> fun <span class="hljs-title">getClient</span><span class="hljs-params">(ssl: SSLSocketFactory, trustManager: X509TrustManager)</span>: OkHttpClient </span>&#123;<br>    <span class="hljs-keyword">return</span> OkHttpClient.Builder()<br>        .retryOnConnectionFailure(<span class="hljs-keyword">true</span>)<br>        .proxy(Proxy.NO_PROXY)<br>        .sslSocketFactory(ssl, trustManager)<br>        .build()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="反防抓包"><a href="#反防抓包" class="headerlink" title="反防抓包"></a>反防抓包</h3><h3 id="常见hook方法"><a href="#常见hook方法" class="headerlink" title="常见hook方法"></a>常见hook方法</h3><h3 id="函数hook问题"><a href="#函数hook问题" class="headerlink" title="函数hook问题"></a>函数hook问题</h3><h4 id="函数头5字节法则"><a href="#函数头5字节法则" class="headerlink" title="函数头5字节法则"></a>函数头5字节法则</h4><h4 id="如果一个函数被hook了怎么检测是哪种hook"><a href="#如果一个函数被hook了怎么检测是哪种hook" class="headerlink" title="如果一个函数被hook了怎么检测是哪种hook"></a>如果一个函数被hook了怎么检测是哪种hook</h4><h3 id="一个app被加壳不能用XPosedhook怎么办"><a href="#一个app被加壳不能用XPosedhook怎么办" class="headerlink" title="一个app被加壳不能用XPosedhook怎么办"></a>一个app被加壳不能用XPosedhook怎么办</h3><h3 id="Abstract怎么追踪实现函数"><a href="#Abstract怎么追踪实现函数" class="headerlink" title="Abstract怎么追踪实现函数"></a>Abstract怎么追踪实现函数</h3><h3 id="jni是怎么实现的（或安卓java层是怎么和so互相调用的）"><a href="#jni是怎么实现的（或安卓java层是怎么和so互相调用的）" class="headerlink" title="jni是怎么实现的（或安卓java层是怎么和so互相调用的）"></a>jni是怎么实现的（或安卓java层是怎么和so互相调用的）</h3><h3 id="fart原理"><a href="#fart原理" class="headerlink" title="fart原理"></a>fart原理</h3><h3 id="VMP原理"><a href="#VMP原理" class="headerlink" title="VMP原理"></a>VMP原理</h3><h3 id="爱加密反调试"><a href="#爱加密反调试" class="headerlink" title="爱加密反调试"></a>爱加密反调试</h3></li>
</ol>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/03/15/%E4%BB%80%E4%B9%88%E6%98%AFOWASP/">什么是OWASP TOP10 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/3.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Srkito/"> Dr.Srkito</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">4</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">2</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">2</span></div></section></div><div id="aside-block" style="order: -1"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">面试问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E6%8A%93%E4%B8%8D%E5%88%B0-%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">1.0.1.</span> <span class="toc-text">抓包抓不到 怎么办</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%8A%93%E5%8C%85"><span class="toc-number">1.0.2.</span> <span class="toc-text">防抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E9%98%B2%E6%8A%93%E5%8C%85"><span class="toc-number">1.0.3.</span> <span class="toc-text">反防抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81hook%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.4.</span> <span class="toc-text">常见hook方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0hook%E9%97%AE%E9%A2%98"><span class="toc-number">1.0.5.</span> <span class="toc-text">函数hook问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%A4%B45%E5%AD%97%E8%8A%82%E6%B3%95%E5%88%99"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">函数头5字节法则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E8%A2%ABhook%E4%BA%86%E6%80%8E%E4%B9%88%E6%A3%80%E6%B5%8B%E6%98%AF%E5%93%AA%E7%A7%8Dhook"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">如果一个函数被hook了怎么检测是哪种hook</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AAapp%E8%A2%AB%E5%8A%A0%E5%A3%B3%E4%B8%8D%E8%83%BD%E7%94%A8XPosedhook%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">1.0.6.</span> <span class="toc-text">一个app被加壳不能用XPosedhook怎么办</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Abstract%E6%80%8E%E4%B9%88%E8%BF%BD%E8%B8%AA%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.7.</span> <span class="toc-text">Abstract怎么追踪实现函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jni%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%88%E6%88%96%E5%AE%89%E5%8D%93java%E5%B1%82%E6%98%AF%E6%80%8E%E4%B9%88%E5%92%8Cso%E4%BA%92%E7%9B%B8%E8%B0%83%E7%94%A8%E7%9A%84%EF%BC%89"><span class="toc-number">1.0.8.</span> <span class="toc-text">jni是怎么实现的（或安卓java层是怎么和so互相调用的）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fart%E5%8E%9F%E7%90%86"><span class="toc-number">1.0.9.</span> <span class="toc-text">fart原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VMP%E5%8E%9F%E7%90%86"><span class="toc-number">1.0.10.</span> <span class="toc-text">VMP原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%B1%E5%8A%A0%E5%AF%86%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">1.0.11.</span> <span class="toc-text">爱加密反调试</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">2018 to 2118</span></nobr><wbr><nobr><p class="text-title">⑨</p><a class="text-content" target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1GJ411x7h7">福星福星，神志不清&nbsp;</a></nobr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>